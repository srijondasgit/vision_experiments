<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Digital Display OCR Gallery Editable</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
body { background:#111; color:#0f0; font-family:monospace; }
#videoContainer { margin-bottom:10px; }
#videoWrapper { position:relative; width:320px; height:240px; }
video, canvas { position:absolute; top:0; left:0; }
#overlay { pointer-events:none; }
button#captureBtn {
  display: block;
  width: 320px;
  margin: 10px 0;
  padding: 5px;
}
#gallery { display:flex; flex-direction:column; gap:10px; margin-top:20px; max-height:600px; overflow-y:auto; }
.snapshot { display:flex; flex-direction:row; align-items:center; border:2px solid #0f0; width:550px; height:240px; }
.snapshot .canvasWrapper { position:relative; width:320px; height:240px; flex-shrink:0; }
.snapshot canvas { position:absolute; top:0; left:0; width:320px; height:240px; }
.snapshot textarea { margin-left:10px; width:120px; height:220px; background:#111; color:#0f0; border:1px solid #0f0; font-family:monospace; font-size:14px; padding:5px; resize:none; }
.snapshot button.deleteBtn { margin-left:10px; padding:5px; cursor:pointer; background:#800; color:#fff; border:none; border-radius:4px; height:30px; align-self:flex-start; }
#canvas { display:none; } /* hidden processing canvas */
</style>
</head>
<body>

<h2>Digital Display OCR Vertical Gallery (Editable)</h2>

<div id="videoContainer">
  <div id="videoWrapper">
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="overlay" width="320" height="240"></canvas>
  </div>
  <button id="captureBtn">Capture & Detect</button>
</div>

<div id="gallery"></div>

<canvas id="canvas"></canvas> <!-- hidden processing canvas -->

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctxOverlay = overlay.getContext('2d');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const captureBtn = document.getElementById('captureBtn');
const gallery = document.getElementById('gallery');

// start camera
async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
}

// OCR on a given canvas
async function processFrame(frameCanvas, frameOverlay, frameTextarea) {
  const ctxOverlay = frameOverlay.getContext('2d');
  ctxOverlay.clearRect(0,0,frameOverlay.width,frameOverlay.height);

  const result = await Tesseract.recognize(
    frameCanvas,
    'eng',
    {
      tessedit_char_whitelist: '0123456789.',
      tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
    }
  );

  // Combine all detected words into lines for editing
  const lines = [];
  if (result.data.words) {
    result.data.words.forEach(word => {
      const text = word.text.trim();
      if (/^[0-9.]+$/.test(text)) {
        lines.push(text);
      }
    });
  }

  frameTextarea.value = lines.join('\n') || "No digits detected";

  // Draw bounding boxes
  if (result.data.words) {
    result.data.words.forEach(word => {
      const text = word.text.trim();
      if (/^[0-9.]+$/.test(text)) {
        const { x0, y0, x1, y1 } = word.bbox;
        const scaleX = frameOverlay.width / frameCanvas.width;
        const scaleY = frameOverlay.height / frameCanvas.height;
        const sx = x0 * scaleX;
        const sy = y0 * scaleY;
        const sw = (x1 - x0) * scaleX;
        const sh = (y1 - y0) * scaleY;

        ctxOverlay.strokeStyle = "lime";
        ctxOverlay.lineWidth = 2;
        ctxOverlay.strokeRect(sx, sy, sw, sh);

        ctxOverlay.fillStyle = "lime";
        ctxOverlay.fillText(text, sx, sy - 5);
      }
    });
  }
}

// Capture button click
captureBtn.addEventListener("click", async () => {
  const snapDiv = document.createElement("div");
  snapDiv.className = "snapshot";

  // Canvas wrapper
  const canvasWrapper = document.createElement("div");
  canvasWrapper.className = "canvasWrapper";

  const snapCanvas = document.createElement("canvas");
  snapCanvas.width = video.videoWidth;
  snapCanvas.height = video.videoHeight;
  canvasWrapper.appendChild(snapCanvas);

  const snapOverlay = document.createElement("canvas");
  snapOverlay.width = 320;
  snapOverlay.height = 240;
  canvasWrapper.appendChild(snapOverlay);

  snapDiv.appendChild(canvasWrapper);

  // Editable OCR textarea
  const snapTextarea = document.createElement("textarea");
  snapTextarea.value = "Detecting...";
  snapDiv.appendChild(snapTextarea);

  // Delete button
  const delBtn = document.createElement("button");
  delBtn.className = "deleteBtn";
  delBtn.innerText = "Delete";
  delBtn.addEventListener("click", () => {
    gallery.removeChild(snapDiv);
  });
  snapDiv.appendChild(delBtn);

  gallery.appendChild(snapDiv);

  // Draw current video frame to hidden canvas
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  // Copy to snapshot canvas
  const snapCtx = snapCanvas.getContext("2d");
  snapCtx.drawImage(canvas, 0, 0, snapCanvas.width, snapCanvas.height);

  // Convert to grayscale
  const imageData = snapCtx.getImageData(0, 0, snapCanvas.width, snapCanvas.height);
  const data = imageData.data;
  for (let i = 0; i < data.length; i += 4) {
    const gray = data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11;
    data[i] = data[i+1] = data[i+2] = gray;
  }
  snapCtx.putImageData(imageData, 0, 0);

  // Run OCR
  await processFrame(snapCanvas, snapOverlay, snapTextarea);
});

// start camera
startCamera();
</script>

</body>
</html>
