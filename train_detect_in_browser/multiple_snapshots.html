<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Digital Display OCR Gallery Editable</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
body { background:#111; color:#0f0; font-family:monospace; margin:10px; }
#videoContainer { margin-bottom:10px; }
#videoWrapper { position:relative; width:100%; max-width:320px; aspect-ratio:4/3; }
video, canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
#overlay { pointer-events:none; }
.btn-row { display:flex; gap:8px; margin:10px 0; width:100%; max-width:320px; }
.btn-row button { flex:1; padding:5px; font-family:monospace; cursor:pointer; }
#captureBtn { background:#111; color:#0f0; border:1px solid #0f0; }
#captureBtn:disabled { opacity:0.4; cursor:not-allowed; }
#switchBtn  { background:#111; color:#0af; border:1px solid #0af; }
#switchBtn:disabled { opacity:0.4; cursor:not-allowed; }
#cameraLabel { font-size:11px; color:#888; margin-bottom:4px; }
#errorMsg { color:#f55; font-size:12px; margin-top:4px; min-height:16px; }
#gallery { display:flex; flex-direction:column; gap:20px; margin-top:20px; max-height:600px; overflow-y:auto; }
.snapshot { display:flex; flex-direction:column; border:2px solid #0f0; width:100%; max-width:550px; }
.snapshot .canvasWrapper { position:relative; width:100%; max-width:320px; aspect-ratio:4/3; margin-bottom:5px; }
.snapshot canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
.snapshot textarea { width:100%; background:#111; color:#0f0; border:1px solid #0f0; font-family:monospace; font-size:14px; padding:5px; resize:none; margin-bottom:5px; }
.snapshot button.deleteBtn { padding:5px; cursor:pointer; background:#800; color:#fff; border:none; border-radius:4px; width:100px; align-self:flex-start; }
#canvas { display:none; }
</style>
</head>
<body>

<h2>Digital Display OCR Gallery (Editable)</h2>

<div id="videoContainer">
  <div id="cameraLabel">ðŸ“· Camera: <span id="facingLabel">Initializing...</span></div>
  <div id="videoWrapper">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>
  <div class="btn-row">
    <button id="captureBtn">Capture &amp; Detect</button>
    <button id="switchBtn" disabled>â‡„ Switch Camera</button>
  </div>
  <div id="errorMsg"></div>
</div>

<div id="gallery"></div>
<canvas id="canvas"></canvas>

<script>
const video       = document.getElementById('video');
const overlay     = document.getElementById('overlay');
const canvas      = document.getElementById('canvas');
const ctx         = canvas.getContext('2d');
const captureBtn  = document.getElementById('captureBtn');
const switchBtn   = document.getElementById('switchBtn');
const facingLabel = document.getElementById('facingLabel');
const errorMsg    = document.getElementById('errorMsg');
const gallery     = document.getElementById('gallery');

let currentStream = null;
let videoDevices  = [];
let currentIndex  = 0;

// â”€â”€ Camera Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  errorMsg.textContent = '';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
    await attachStream(stream);
    await enumerateDevices();
    const activeId = currentStream.getVideoTracks()[0].getSettings().deviceId;
    const matched  = videoDevices.findIndex(d => d.deviceId === activeId);
    if (matched !== -1) currentIndex = matched;
    updateLabel();
    switchBtn.disabled = videoDevices.length < 2;
  } catch (err) {
    handleError(err);
  }
}

async function enumerateDevices() {
  const all = await navigator.mediaDevices.enumerateDevices();
  videoDevices = all.filter(d => d.kind === 'videoinput');
}

async function attachStream(stream) {
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
  currentStream  = stream;
  video.srcObject = stream;
  await video.play().catch(() => {});
}

async function switchCamera() {
  if (videoDevices.length < 2) return;
  switchBtn.disabled = true;
  errorMsg.textContent = '';

  currentIndex = (currentIndex + 1) % videoDevices.length;
  const deviceId = videoDevices[currentIndex].deviceId;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
    await attachStream(stream);
    updateLabel();
  } catch (err) {
    currentIndex = (currentIndex - 1 + videoDevices.length) % videoDevices.length;
    handleError(err);
  } finally {
    switchBtn.disabled = false;
  }
}

function updateLabel() {
  if (!currentStream) return;
  const settings = currentStream.getVideoTracks()[0].getSettings();
  const facing   = settings.facingMode;
  if (facing === 'environment') facingLabel.textContent = 'Rear ðŸ”­';
  else if (facing === 'user') facingLabel.textContent = 'Front ðŸ¤³';
  else {
    const label = (videoDevices[currentIndex]?.label || '').toLowerCase();
    if (label.includes('back') || label.includes('rear')) facingLabel.textContent = 'Rear ðŸ”­';
    else if (label.includes('front') || label.includes('selfie')) facingLabel.textContent = 'Front ðŸ¤³';
    else facingLabel.textContent = `Cam ${currentIndex+1} of ${videoDevices.length}`;
  }
}

function handleError(err) {
  console.error(err);
  let msg = 'âš  ' + (err.message || err.name || 'Unknown error');
  if (err.name === 'NotAllowedError') msg = 'âš  Camera permission denied.';
  else if (err.name === 'NotFoundError') msg = 'âš  No camera found on this device.';
  else if (err.name === 'NotReadableError') msg = 'âš  Camera in use by another app.';
  errorMsg.textContent = msg;
  facingLabel.textContent = 'Error';
}

// â”€â”€ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processFrame(frameCanvas, frameOverlay, frameTextarea) {
  const ctxOv = frameOverlay.getContext('2d');
  ctxOv.clearRect(0, 0, frameOverlay.width, frameOverlay.height);

  const result = await Tesseract.recognize(frameCanvas, 'eng', {
    tessedit_char_whitelist: '0123456789.',
    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
  });

  const lines = [];
  if (result.data.words) {
    result.data.words.forEach(word => {
      const text = word.text.trim();
      if (/^[0-9.]+$/.test(text)) {
        lines.push(text);
        const { x0, y0, x1, y1 } = word.bbox;
        const scaleX = frameOverlay.width  / frameCanvas.width;
        const scaleY = frameOverlay.height / frameCanvas.height;
        ctxOv.strokeStyle = 'lime';
        ctxOv.lineWidth   = 2;
        ctxOv.strokeRect(x0*scaleX, y0*scaleY, (x1-x0)*scaleX, (y1-y0)*scaleY);
        ctxOv.fillStyle   = 'lime';
        ctxOv.fillText(text, x0*scaleX, y0*scaleY - 5);
      }
    });
  }
  frameTextarea.value = lines.join('\n') || 'No digits detected';
}

// â”€â”€ Capture with max 5 snapshots, newest at top â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
captureBtn.addEventListener('click', async () => {
  if (gallery.children.length >= 5) {
    captureBtn.disabled = true; // Disable button at 5 snapshots
  }

  const snapDiv = document.createElement('div');
  snapDiv.className = 'snapshot';

  const canvasWrapper = document.createElement('div');
  canvasWrapper.className = 'canvasWrapper';

  const snapCanvas = document.createElement('canvas');
  snapCanvas.width  = video.videoWidth  || 320;
  snapCanvas.height = video.videoHeight || 240;
  canvasWrapper.appendChild(snapCanvas);

  const snapOverlay = document.createElement('canvas');
  snapOverlay.width  = 320;
  snapOverlay.height = 240;
  canvasWrapper.appendChild(snapOverlay);

  snapDiv.appendChild(canvasWrapper);

  const snapTextarea = document.createElement('textarea');
  snapTextarea.value = 'Detecting...';
  snapDiv.appendChild(snapTextarea);

  const delBtn = document.createElement('button');
  delBtn.className = 'deleteBtn';
  delBtn.innerText  = 'Delete';
  delBtn.addEventListener('click', () => {
    gallery.removeChild(snapDiv);
    if (gallery.children.length < 5) captureBtn.disabled = false;
  });
  snapDiv.appendChild(delBtn);

  gallery.prepend(snapDiv); // Newest snapshot at top

  canvas.width  = video.videoWidth  || 320;
  canvas.height = video.videoHeight || 240;
  ctx.drawImage(video, 0, 0);

  const snapCtx = snapCanvas.getContext('2d');
  snapCtx.drawImage(canvas, 0, 0, snapCanvas.width, snapCanvas.height);

  // Grayscale
  const imageData = snapCtx.getImageData(0, 0, snapCanvas.width, snapCanvas.height);
  const data = imageData.data;
  for (let i = 0; i < data.length; i += 4) {
    const gray = data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11;
    data[i] = data[i+1] = data[i+2] = gray;
  }
  snapCtx.putImageData(imageData, 0, 0);

  await processFrame(snapCanvas, snapOverlay, snapTextarea);
});

switchBtn.addEventListener('click', switchCamera);
init();
</script>

</body>
</html>
